sudo: required
env:
  global:
  - DIST_REPO="f5-openstack-lbaasv2-driver-dist"
  - PKG_VERSION=$(python -c "import f5lbaasdriver; print f5lbaasdriver.__version__")
  - PKG_RELEASE=$(python ${DIST_REPO}/scripts/get-version-release.py --release)
  - PKG_RELEASE_EL7=${DIST_REPO}/rpms/f5-openstack-lbaasv2-driver-${PKG_VERSION}-1.el7.noarch.rpm
  - PKG_RELEASE_1404=${DIST_REPO}/deb_dist/python-f5-openstack-lbaasv2-driver_${PKG_VERSION}-${PKG_RELEASE}_1404_all.deb
  - RELEASE_TAG=v$(echo $PKG_VERSION | cut -d . -f 1,2)
services:
- docker
language: python
python:
- '2.7'
before_install:
- git config --global user.email "OpenStack_TravisCI@f5.com"
- git config --global user.name "Travis F5 Openstack"
- wget https://github.com/F5Networks/docker-images/raw/master/centos:6.tar.gz
- wget https://github.com/F5Networks/docker-images/raw/master/centos:7.tar.gz
- wget https://github.com/F5Networks/docker-images/raw/master/f5devcentral_containthedocs:latest.tar.gz
- wget https://github.com/F5Networks/docker-images/raw/master/ubuntu:trusty.tar.gz
- wget https://github.com/F5Networks/docker-images/raw/master/ubuntu:xenial.tar.gz
- docker load -i centos:6.tar.gz
- docker load -i centos:7.tar.gz
- docker load -i f5devcentral_containthedocs:latest.tar.gz
- docker load -i ubuntu:trusty.tar.gz
- docker load -i ubuntu:xenial.tar.gz
install:
- python -m pip install pip==9.0.3
- pip install hacking==1.1.0 pytest coverage
- pip install -r requirements.test.txt
script:
- flake8 ./f5lbaasdriver
- coverage run --source f5lbaasdriver -m py.test f5lbaasdriver/v2/bigip/
- coverage report
- f5-openstack-lbaasv2-driver-dist/scripts/package.sh "redhat" "7"
- f5-openstack-lbaasv2-driver-dist/scripts/package.sh "ubuntu" "14.04"
- sudo chown -R travis:travis ${DIST_REPO}/rpms
- sudo chown -R travis:travis ${DIST_REPO}/deb_dist/*.deb
- ./docs/scripts/docker-docs.sh ./docs/scripts/test-docs.sh
after_success:
  - md5sum ${PKG_RELEASE_EL7} > ${PKG_RELEASE_EL7}.md5 && md5sum --check ${PKG_RELEASE_EL7}.md5
  - md5sum ${PKG_RELEASE_1404} > ${PKG_RELEASE_1404}.md5 && md5sum --check ${PKG_RELEASE_1404}.md5
  - f5-openstack-lbaasv2-driver-dist/scripts/test_install.sh "redhat" "7"
  - f5-openstack-lbaasv2-driver-dist/scripts/test_install.sh "ubuntu" "14.04"
deploy:
  - provider: releases
    api_key:
      secure: "iFpUAG1J8pnxL/lyIm4t18gQx0OaajpXWSEIQr0QeiKFKAj5mZ0rTr4XD4ditLKZ7Ar/ZcPlD+wJ6k4MEVjrkDs+SxSgMKoygXIu35m4pxNpUNPbyR1q0etfpnyMWr7KZWPhqzQw4FbQgAdNvA4l0CQi9ufaFIzE0gZl/uKW+CJbjRp+VrFKSeK1BuUSrjzS9iwwPy4DnxzOxmA8d3PLj/BCmh+rdjLHvdEAdVO5mRn6h2uTOTYsrYY+QBgI0Ibi1oiy6hkrW5snqEpaeg5w5fbcI9zds3QXWJucQSjBF8EFVgwcHHDM1Z339pnxbYHWZg683Q9tMjpUhgrc+CJxVW1O+vUaVkCa/6Js8B46RwgpZmBOWotxvYFfL/sxrvhh7mxnl/KSAHxMJ1NoReaS8SLBHqQu12/jyOQlblj+/jB/P/jAoj8R7S2p83FyNNuTg22zEV7oXIruaEsz4qfMNPR3RfVOTYzvKZPq6II67lHd5qNjAWNLpeDisBqHQ8dmE53Q10DtCLbzvzlLHbLtFExYToG1vwWNoe641vCa/ZEII2e0t0+tRIdXJ80Jgt2hHdTPpng0Xgsthf05SCwi2A9p0exVJt95ty7kEEUrpUZ9yEGFyO7H3kDvK7gk345BsMo7wIpoXgpp4uRwHy1Ylw3ZJPZG/J8Ju2D1eHtbF5Y="
    file:
      - ${PKG_RELEASE_EL7}
      - ${PKG_RELEASE_EL7}.md5
      - ${PKG_RELEASE_1404}
      - ${PKG_RELEASE_1404}.md5
    skip_cleanup: true
    overwrite: true
    on:
      repo: F5Networks/f5-openstack-lbaasv2-driver
      tags: true
  #- provider: pypi
  #  user: $PYPI_USER
  #  password: $PYPI_PASSWORD
  #  server: https://upload.pypi.org/legacy/
  #  on:
  #    all_branches: true
  #    tags: true
  #    python: 2.7
  #  skip_cleanup: true
  # deploy docs to s3
  - provider: script
    skip_cleanup: true
    on:
      branch: stable/pike
      repo: F5Networks/f5-openstack-lbaasv2-driver
      condition: $TRAVIS_TAG = ""
    script:
    - ./docs/scripts/deploy-docs.sh publish-product-docs-to-prod openstack/lbaasv2-driver pike
  # For tagged releases, the docs publish at /products/openstack/lbaasv2-driver/<branch-name>/vX.Y
  # This section is commented out on the master branch because we don't need to publish tagged releases to /master
  - provider: script
    skip_cleanup: true
    on:
      tags: true
      repo: F5Networks/f5-openstack-lbaasv2-driver
    script:
    - ./docs/scripts/deploy-docs.sh publish-product-docs-to-prod openstack/lbaasv2-driver/pike $RELEASE_TAG
